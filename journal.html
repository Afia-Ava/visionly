<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionly - Journal</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="journal.css">
    <link rel="stylesheet" href="dark-mode-global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <style>
        /* Override any CSS that might be preventing scrolling */
        html, body {
            height: auto !important;
            overflow: visible !important;
            overflow-y: auto !important;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fff;
            background-image: 
              linear-gradient(135deg, rgba(139, 95, 179, 0.03) 25%, transparent 25%), 
              linear-gradient(225deg, rgba(139, 95, 179, 0.03) 25%, transparent 25%), 
              linear-gradient(45deg, rgba(139, 95, 179, 0.03) 25%, transparent 25%), 
              linear-gradient(315deg, rgba(139, 95, 179, 0.03) 25%, transparent 25%);
            background-size: 20px 20px;
            background-position: 10px 0, 10px 0, 0 0, 0 0;
            color: #333;
            margin: 0;
            padding: 0;
            transition: all 0.3s ease;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #0a0612;
            background-image: 
                linear-gradient(135deg, rgba(139, 95, 179, 0.06) 25%, transparent 25%), 
                linear-gradient(225deg, rgba(139, 95, 179, 0.06) 25%, transparent 25%), 
                linear-gradient(45deg, rgba(139, 95, 179, 0.06) 25%, transparent 25%), 
                linear-gradient(315deg, rgba(139, 95, 179, 0.06) 25%, transparent 25%);
            color: #e0e0e0;
        }
        
        body.dark-mode .navbar {
            background-color: #0a0612 !important;
            box-shadow: 0 1px 3px rgba(139, 95, 179, 0.15) !important;
        }
        
        body.dark-mode .navbar a,
        body.dark-mode .navbar .logo {
            color: #e0e0e0 !important;
        }
        
        body.dark-mode h1 {
            color: #e0e0e0 !important;
        }
        
        body.dark-mode p {
            color: #b0b0b0 !important;
        }
        
        body.dark-mode h3 {
            color: #e0e0e0 !important;
        }
        
        body.dark-mode div[style*="background: white"] {
            background: #1f0f35 !important;
            box-shadow: 0 2px 4px rgba(139, 95, 179, 0.15) !important;
        }
        
        body.dark-mode input,
        body.dark-mode textarea {
            background-color: #2d1549 !important;
            border-color: #3a2259 !important;
            color: #e0e0e0 !important;
        }
        
        body.dark-mode input::placeholder,
        body.dark-mode textarea::placeholder {
            color: #888 !important;
        }
        
        body.dark-mode button[style*="background: #2d1a45"] {
            background: #2d1a45 !important;
        }
        
        body.dark-mode button[style*="background: #dc3545"] {
            background: #dc3545 !important;
        }
        
        body.dark-mode .mood-btn {
            background: #2d1549 !important;
            border-color: #3a2259 !important;
        }
        
        body.dark-mode div[style*="background: #f8f9fa"] {
            background: #2d1549 !important;
        }
        
        body.dark-mode div[style*="color: #666"] {
            color: #b0b0b0 !important;
        }
        
        body.dark-mode span {
            color: #b0b0b0 !important;
        }
        
        body.dark-mode label {
            color: #b0b0b0 !important;
        }
        
        body.dark-mode div[style*="border-top: 1px solid #eee"] {
            border-top: 1px solid #3a2259 !important;
        }
        
        /* Journal entry titles in dark mode */
        body.dark-mode #entries-list div[style*="font-weight: 500"] {
            color: #e0e0e0 !important;
        }
        
        body.dark-mode #entries-list .entry-title {
            color: #e0e0e0 !important;
        }
        
        /* More specific selector for journal entry titles */
        body.dark-mode #entries-list div div[style*="font-weight: 500"] {
            color: #e0e0e0 !important;
        }
        
        /* Target the dynamically created entry title divs */
        body.dark-mode #entries-list > div > div:first-child {
            color: #e0e0e0 !important;
        }
    </style>
</head>
<body style="font-family: 'Inter', sans-serif; background-color: #fff; background-image: linear-gradient(135deg, rgba(139, 95, 179, 0.03) 25%, transparent 25%), linear-gradient(225deg, rgba(139, 95, 179, 0.03) 25%, transparent 25%), linear-gradient(45deg, rgba(139, 95, 179, 0.03) 25%, transparent 25%), linear-gradient(315deg, rgba(139, 95, 179, 0.03) 25%, transparent 25%); background-size: 20px 20px; background-position: 10px 0, 10px 0, 0 0, 0 0; color: #333; margin: 0; padding: 0;">
    <nav class="navbar" style="position: fixed; top: 0; width: 100%; background-color: #fff; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); padding: 14px 30px; height: 70px; display: flex; align-items: center; justify-content: space-between; z-index: 1000; box-sizing: border-box;">
        <a href="index.html" class="logo" style="font-family: 'Dancing Script', cursive; font-weight: bold; font-size: 2rem; color: #333; text-decoration: none;">Visionly</a>
        <div style="display: flex; align-items: center;">
            <a href="index.html" style="text-decoration: none; color: #333; margin: 0 12px;">Home</a>
            <a href="create-board.html" style="text-decoration: none; color: #333; margin: 0 12px;">Create</a>
            <a href="boards.html" style="text-decoration: none; color: #333; margin: 0 12px;">Boards</a>
            <a href="progress.html" style="text-decoration: none; color: #333; margin: 0 12px;">Progress</a>
            <a href="elevate.html" style="text-decoration: none; color: #333; margin: 0 12px; margin-right: 15px;">Elevate</a>
            <img id="profile-photo" src="https://via.placeholder.com/40x40/ff6b6b/ffffff?text=U" alt="Profile" style="width: 38px; height: 38px; border-radius: 50%; cursor: pointer;">
        </div>
    </nav>

    <div id="navbar-container"></div>
    
    <!-- Centered Header -->
    <div style="text-align: center; margin-top: 100px; margin-bottom: 40px;">
        <h1 style="font-size: 2rem; font-weight: bold; color: #333; margin-bottom: 5px;">Journal Entry</h1>
        <p style="color: #666; margin-top: 0; margin-bottom: 0;">A canvas for your thoughts and intentions</p>
    </div>
    
    <main style="display: flex; max-width: 1200px; margin: 0 auto; padding: 20px; gap: 20px; padding-bottom: 100px;">
        <!-- Left Sidebar with Calendar and Previous Entries -->
        <div style="flex: 0 0 280px; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <!-- Calendar Section -->
            <div style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <button id="prev-month" style="background: none; border: none; font-size: 18px; cursor: pointer;">‚Äπ</button>
                    <h3 id="month-year" style="margin: 0; font-size: 16px; font-weight: 600;">June 2025</h3>
                    <button id="next-month" style="background: none; border: none; font-size: 18px; cursor: pointer;">‚Ä∫</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 12px;">
                    <div style="text-align: center; padding: 5px; font-weight: 600; color: #666;">S</div>
                    <div style="text-align: center; padding: 5px; font-weight: 600; color: #666;">M</div>
                    <div style="text-align: center; padding: 5px; font-weight: 600, color: #666;">T</div>
                    <div style="text-align: center; padding: 5px; font-weight: 600, color: #666;">W</div>
                    <div style="text-align: center; padding: 5px; font-weight: 600, color: #666;">T</div>
                    <div style="text-align: center; padding: 5px; font-weight: 600, color: #666;">F</div>
                    <div style="text-align: center; padding: 5px; font-weight: 600, color: #666;">S</div>
                </div>
                <div id="calendar-days" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-top: 5px;">
                    <!-- Calendar days will be generated by JavaScript -->
                </div>
            </div>
            
            <!-- Previous Entries -->
            <div>
                <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600;">Previous Entries</h3>
                <!-- Search bar for journals -->
                <input id="journal-search" type="text" placeholder="Search journals by title, tag, or content..." style="width: 100%; margin-bottom: 10px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                <div id="entries-list" style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="padding: 15px; text-align: center; color: #666; font-style: italic; font-size: 14px;">
                        You do not have any journal yet. Write your first journal!
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div style="flex: 1; display: flex; flex-direction: column; gap: 20px;">
            <!-- Header with Entry Actions -->
            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 10px;">
                    <button style="background: #2d1a45; color: white; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        Get Prompt
                    </button>
                    <button style="background: #2d1a45; color: white; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        New Entry
                    </button>
                </div>
            </div>

            <!-- Entry Content -->
            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column;">
                <!-- Entry Title and Mood in one row -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center;">
                    <input type="text" placeholder="Entry Title" style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; font-weight: 500;">
                    
                    <!-- Compact Mood Section -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-weight: 500; color: #666; font-size: 14px;">Mood:</label>
                        <div style="display: flex; gap: 5px;">
                            <button class="mood-btn" data-mood="üòä" style="width: 32px; height: 32px; border: 2px solid #ddd; border-radius: 6px; background: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;">üòä</button>
                            <button class="mood-btn" data-mood="üòå" style="width: 32px; height: 32px; border: 2px solid #ddd; border-radius: 6px; background: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;">üòå</button>
                            <button class="mood-btn" data-mood="ü§î" style="width: 32px; height: 32px; border: 2px solid #ddd; border-radius: 6px; background: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;">ü§î</button>
                            <button class="mood-btn" data-mood="üòî" style="width: 32px; height: 32px; border: 2px solid #ddd; border-radius: 6px; background: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;">üòî</button>
                            <button class="mood-btn" data-mood="üò§" style="width: 32px; height: 32px; border: 2px solid #ddd; border-radius: 6px; background: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;">üò§</button>
                        </div>
                    </div>
                </div>
                <!-- Tag input row -->
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <input type="text" id="tag-input" placeholder="Add tags (comma separated, e.g. gratitude, goals)" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                </div>
                <textarea placeholder="Write your journal entry here..." style="width: 100%; height: 400px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; line-height: 1.6; resize: vertical; font-family: 'Inter', sans-serif; box-sizing: border-box;"></textarea>
                
                <!-- Voice Journal Controls (moved to end, now records audio) -->
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 12px; margin-bottom: 10px;">
                    <button id="start-voice" style="background: #2d1a45; color: #fff; border: none; border-radius: 6px; padding: 8px 14px; font-size: 14px; cursor: pointer;">
                        <i class="fa fa-microphone"></i> Start Voice Journal
                    </button>
                    <button id="stop-voice" style="background: #dc3545; color: #fff; border: none; border-radius: 6px; padding: 8px 14px; font-size: 14px; cursor: pointer; display: none;">
                        <i class="fa fa-stop"></i> Stop
                    </button>
                    <span id="voice-status" style="font-size: 13px; color: #666;"></span>
                    <audio id="voice-playback" controls style="display:none; margin-left:10px; height:28px;"></audio>
                </div>
                
                <!-- Footer with Save Status -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                    <span style="color: #666; font-size: 14px;">All changes saved</span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="clear-entry" style="background: #dc3545; color: white; border: none; border-radius: 6px; padding: 8px 12px; font-size: 14px; cursor: pointer;">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Background Sound -->
    <audio id="background-sound" loop>
        <source src="assets/relaxing-nature-sound.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Toggle Sound Button -->
    <button id="toggle-sound" style="position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: #2d1a45; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(45, 26, 69, 0.3); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: transform 0.2s ease;">
        <img src="assets/speaker-on-icon.png" alt="Sound On" id="sound-icon" style="width: 20px; height: 20px; filter: brightness(0) invert(1);">
    </button>

    <!-- Prompt Modal (hidden by default) -->
    <div id="prompt-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(30,20,40,0.35); z-index:2000; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:14px; max-width:400px; width:90%; margin:auto; box-shadow:0 8px 32px rgba(45,26,69,0.18); padding:32px 24px 24px 24px; position:relative;">
            <button id="close-prompt-modal" style="position:absolute; top:12px; right:16px; background:none; border:none; font-size:20px; color:#888; cursor:pointer;">&times;</button>
            <h2 style="margin-top:0; font-size:1.3rem; text-align:center;">Choose a Prompt Category</h2>
            <div id="prompt-categories" style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin:18px 0 22px 0;">
                <button class="prompt-cat-btn" data-cat="growth" style="flex:1 1 40%; min-width:120px; background:#f3f0ff; border:none; border-radius:8px; padding:12px; font-size:1.1rem; cursor:pointer; display:flex; align-items:center; gap:8px; justify-content:center;">üå± Growth</button>
                <button class="prompt-cat-btn" data-cat="motivation" style="flex:1 1 40%; min-width:120px; background:#f3f0ff; border:none; border-radius:8px; padding:12px; font-size:1.1rem; cursor:pointer; display:flex; align-items:center; gap:8px; justify-content:center;">üí™ Motivation</button>
                <button class="prompt-cat-btn" data-cat="stress" style="flex:1 1 40%; min-width:120px; background:#f3f0ff; border:none; border-radius:8px; padding:12px; font-size:1.1rem; cursor:pointer; display:flex; align-items:center; gap:8px; justify-content:center;">üò∞ Stress</button>
                <button class="prompt-cat-btn" data-cat="dreams" style="flex:1 1 40%; min-width:120px; background:#f3f0ff; border:none; border-radius:8px; padding:12px; font-size:1.1rem; cursor:pointer; display:flex; align-items:center; gap:8px; justify-content:center;">‚ú® Dreams</button>
            </div>
            <div id="prompt-list" style="display:none; flex-direction:column; gap:10px;">
                <button id="back-to-categories" style="background:none; border:none; color:#8b5fbf; font-size:14px; margin-bottom:10px; cursor:pointer; text-align:left;">‚Üê Back to categories</button>
                <div id="prompt-items"></div>
            </div>
        </div>
    </div>

    <script src="nav-auth.js"></script>
    <script src="journal.js"></script>
    <script src="global-sound.js"></script>
    <script src="shared-scripts.js"></script>
    <script src="profile-dropdown.js"></script>
    <script src="dark-mode-toggle.js"></script>
    
    <!-- Import sprinkles effect from mouse-sprinkles -->
    <script src="mouse-sprinkles-script.js"></script>
    
    <script>
        // Global variables for journal entries
        let journalEntries = [];
        
        // Journal prompts array
        const journalPrompts = [
            "What are three things you're genuinely grateful for today, and why do they matter to you?",
            "Describe a moment this week when you felt completely at peace. What made it special?",
            "If you could have a conversation with your future self, what would you want to know?",
            "What's one fear you've overcome recently, and how did it change you?",
            "Write about a person who inspires you. What qualities do they have that you admire?",
            "What does success mean to you personally, beyond what others expect?",
            "Describe your ideal day from morning to night. What would make it perfect?",
            "What's something you've learned about yourself in the past month?",
            "If you could give advice to someone going through what you went through last year, what would you say?",
            "What small act of kindness could you do tomorrow that would make someone's day better?",
            "Write about a challenge you're facing. What strengths do you have to overcome it?",
            "What's a dream you've been putting off? What's one small step you could take toward it today?",
            "Describe a place where you feel most like yourself. What is it about that place?",
            "What are you most proud of accomplishing this year, no matter how small?",
            "If you could change one thing about how you spend your time, what would it be?",
            "Write about someone who believed in you when you didn't believe in yourself.",
            "What's something you do that brings you pure joy, and how can you do more of it?",
            "Describe a mistake you made that taught you something valuable.",
            "What would you do if you knew you couldn't fail?",
            "Write about a moment when you felt truly connected to someone or something.",
            "What's one habit you want to develop, and why is it important to you?",
            "If today was your last day, what would you want people to remember about you?",
            "What's something you've been avoiding, and what's the first step to facing it?",
            "Describe a time when you surprised yourself with your own strength or resilience.",
            "What does 'home' mean to you, and where do you feel most at home?",
            "Write about a book, movie, or song that changed your perspective on something.",
            "What's one thing you wish you could tell your younger self?",
            "Describe your biggest dream. What would achieving it feel like?",
            "What's something you're excited about in the near future?",
            "Write about a tradition or ritual that's meaningful to you and why.",
            "What's one way you've grown or changed in the past six months?",
            "If you could master any skill instantly, what would it be and how would you use it?",
            "Describe a moment when you felt truly proud of who you are.",
            "What's something you want to let go of that's no longer serving you?",
            "Write about the best advice you've ever received and how it impacted your life."
        ];

        // Function to get a random prompt
        function getRandomPrompt() {
            const randomIndex = Math.floor(Math.random() * journalPrompts.length);
            return journalPrompts[randomIndex];
        }

        function loadEntriesFromStorage() {
            const saved = localStorage.getItem('journalEntries');
            if (saved) {
                journalEntries = JSON.parse(saved);
                displaySavedEntries();
            }
        }
        function saveEntriesToStorage() {
            localStorage.setItem('journalEntries', JSON.stringify(journalEntries));
        }

        function displaySavedEntries(filtered) {
            const entriesList = document.getElementById('entries-list');
            entriesList.innerHTML = '';

            // Use filtered if provided, else all
            const entriesToShow = filtered || journalEntries;

            if (entriesToShow.length === 0) {
                const noEntriesDiv = document.createElement('div');
                noEntriesDiv.style.cssText = 'padding: 15px; text-align: center; color: #666; font-style: italic; font-size: 14px;';
                noEntriesDiv.textContent = 'You do not have any journal yet. Write your first journal!';
                entriesList.appendChild(noEntriesDiv);
                return;
            }

            entriesToShow.forEach((entry, index) => {
                createEntryElement(entry, journalEntries.indexOf(entry));
            });
        }

        function createEntryElement(entry, index) {
            const entriesList = document.getElementById('entries-list');
            
            const entryElement = document.createElement('div');
            entryElement.style.cssText = 'padding: 10px; background: #f8f9fa; border-radius: 8px; cursor: pointer; border-left: 3px solid #2d1a45; position: relative; margin-bottom: 8px;';
            entryElement.dataset.index = index;
            
            const entryTitleDiv = document.createElement('div');
            entryTitleDiv.style.cssText = 'font-weight: 500; font-size: 14px; margin-bottom: 4px; color: #333;';
            entryTitleDiv.textContent = entry.title || 'Untitled Entry';
            entryTitleDiv.classList.add('entry-title');
            
            // Check if dark mode is active and apply appropriate color
            if (document.body.classList.contains('dark-mode')) {
                entryTitleDiv.style.setProperty('color', '#2d1a45', 'important');
            }
            
            const entryDate = document.createElement('div');
            entryDate.style.cssText = 'font-size: 12px; color: #666;';
            entryDate.textContent = entry.date;
            
            // Tag display
            let tagDiv = null;
            if (entry.tags && entry.tags.length) {
                tagDiv = document.createElement('div');
                tagDiv.style.cssText = 'margin-top: 2px; margin-bottom: 2px; display: flex; flex-wrap: wrap; gap: 5px;';
                entry.tags.forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.textContent = '#' + tag;
                    tagSpan.style.cssText = 'background: #eae6f7; color: #8b5fbf; border-radius: 5px; padding: 2px 8px; font-size: 12px;';
                    tagDiv.appendChild(tagSpan);
                });
            }
            
            if (entry.mood) {
                const moodSpan = document.createElement('span');
                moodSpan.style.cssText = 'margin-left: 8px; font-size: 14px;';
                moodSpan.textContent = entry.mood;
                entryDate.appendChild(moodSpan);
            }
            
            // Create delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '√ó';
            deleteBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: none; line-height: 1;';
            
            // Show/hide delete button on hover
            entryElement.addEventListener('mouseenter', function() {
                deleteBtn.style.display = 'block';
            });
            
            entryElement.addEventListener('mouseleave', function() {
                deleteBtn.style.display = 'none';
            });
            
            // Delete functionality
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (confirm('Are you sure you want to delete this entry?')) {
                    journalEntries.splice(index, 1);
                    saveEntriesToStorage();
                    displaySavedEntries();
                    
                    // Clear form if this entry was being viewed
                    const entryTitle = document.querySelector('input[placeholder="Entry Title"]');
                    const entryTextarea = document.querySelector('textarea');
                    entryTitle.value = '';
                    entryTextarea.value = '';
                    
                    // Reset mood selection
                    document.querySelectorAll('.mood-btn').forEach(b => {
                        b.style.borderColor = '#ddd';
                        b.style.background = 'white';
                    });
                }
            });
            
            // Load entry functionality
            entryElement.addEventListener('click', function() {
                const entryTitle = document.querySelector('input[placeholder="Entry Title"]');
                const entryTextarea = document.querySelector('textarea');
                const tagInput = document.getElementById('tag-input');
                
                entryTitle.value = entry.title;
                entryTextarea.value = entry.content;
                if (tagInput) tagInput.value = (entry.tags || []).join(', ');
                
                // Reset mood selection
                document.querySelectorAll('.mood-btn').forEach(b => {
                    b.style.borderColor = '#ddd';
                    b.style.background = 'white';
                });
                
                // Select the saved mood
                if (entry.mood) {
                    const moodBtn = document.querySelector(`[data-mood="${entry.mood}"]`);
                    if (moodBtn) {
                        moodBtn.style.borderColor = '#2d1a45';
                        moodBtn.style.background = '#f3f0ff';
                    }
                }
                
                // Update border for selected entry
                document.querySelectorAll('#entries-list > div').forEach(d => {
                    d.style.borderLeft = '3px solid transparent';
                });
                this.style.borderLeft = '3px solid #2d1a45';
            });
            
            entryElement.appendChild(entryTitleDiv);
            if (tagDiv) entryElement.appendChild(tagDiv);
            entryElement.appendChild(entryDate);
            entryElement.appendChild(deleteBtn);
            
            entriesList.appendChild(entryElement);
        }

        // Calendar functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Load entries from storage first
            loadEntriesFromStorage();

            // --- Journal search functionality ---
            const searchInput = document.getElementById('journal-search');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const q = this.value.trim().toLowerCase();
                    if (!q) {
                        displaySavedEntries();
                        return;
                    }
                    const filtered = journalEntries.filter(entry => {
                        // Search in title, content, tags
                        const inTitle = (entry.title || '').toLowerCase().includes(q);
                        const inContent = (entry.content || '').toLowerCase().includes(q);
                        const inTags = (entry.tags || []).some(tag => tag.toLowerCase().includes(q));
                        return inTitle || inContent || inTags;
                    });
                    displaySavedEntries(filtered);
                });
            }

            const monthYear = document.getElementById('month-year');
            const calendarDays = document.getElementById('calendar-days');
            const prevMonth = document.getElementById('prev-month');
            const nextMonth = document.getElementById('next-month');
            
            let currentDate = new Date();
            
            function generateCalendar(year, month) {
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDayOfWeek = firstDay.getDay();
                const daysInMonth = lastDay.getDate();

                const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];

                monthYear.textContent = `${monthNames[month]} ${year}`;
                calendarDays.innerHTML = '';

                // Get current date for highlighting
                const today = new Date();
                const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
                const currentDateNum = today.getDate();

                // Fill in empty cells before the first day of the month
                for (let i = 0; i < startDayOfWeek; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.style.cssText = 'padding: 8px;';
                    calendarDays.appendChild(emptyCell);
                }

                // Fill in days of the current month only
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayElement = document.createElement('div');
                    dayElement.textContent = day;

                    // Check if this is today's date
                    const isToday = isCurrentMonth && day === currentDateNum;

                    dayElement.style.cssText = `
                        text-align: center; 
                        padding: 8px; 
                        cursor: pointer; 
                        border-radius: 4px;
                        font-size: 14px;
                        color: #333;
                        ${isToday ? 'background: #2d1a45; color: white; font-weight: 600;' : ''}
                        transition: box-shadow 0.15s;
                    `;

                    // Add a class for today for easier re-highlighting
                    if (isToday) {
                        dayElement.classList.add('calendar-today');
                    }

                    dayElement.addEventListener('click', function() {
                        // Remove highlight from all except today
                        document.querySelectorAll('#calendar-days div').forEach(d => {
                            if (d.classList.contains('calendar-today')) {
                                d.style.background = '#2d1a45';
                                d.style.color = 'white';
                                d.style.fontWeight = '600';
                            } else {
                                d.style.background = '';
                                d.style.color = '#333';
                                d.style.fontWeight = '';
                            }
                            d.style.boxShadow = '';
                        });
                        // Add a subtle outline to the selected date (but don't change color)
                        if (!this.classList.contains('calendar-today')) {
                            this.style.boxShadow = '0 0 0 2px #8b5fbf inset';
                        }
                    });

                    calendarDays.appendChild(dayElement);
                }
                // No trailing days from next month
            }
            
            prevMonth.addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() - 1);
                generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
            });
            
            nextMonth.addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() + 1);
                generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
            });
            
            // Mood selection functionality
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mood-btn').forEach(b => {
                        b.style.borderColor = '#ddd';
                        b.style.background = 'white';
                    });
                    this.style.borderColor = '#2d1a45';
                    this.style.background = '#f3f0ff';
                });
            });
            
            // Get Prompt and New Entry functionality
            const buttons = document.querySelectorAll('button');
            let getPromptBtn = null;
            let newEntryBtn = null;
            
            // Find the buttons by their text content
            buttons.forEach(btn => {
                if (btn.textContent.trim() === 'Get Prompt') {
                    getPromptBtn = btn;
                } else if (btn.textContent.trim() === 'New Entry') {
                    newEntryBtn = btn;
                }
            });
            
            const entryTitle = document.querySelector('input[placeholder="Entry Title"]');
            const entryTextarea = document.querySelector('textarea');
            
            // Get Prompt functionality
            if (getPromptBtn) {
                getPromptBtn.addEventListener('click', function() {
                    const prompt = getRandomPrompt();
                    
                    // Clear current content
                    entryTitle.value = '';
                    entryTextarea.value = '';
                    
                    // Reset mood selection
                    document.querySelectorAll('.mood-btn').forEach(b => {
                        b.style.borderColor = '#ddd';
                        b.style.background = 'white';
                    });
                    
                    // Reset entry selection
                    document.querySelectorAll('#entries-list > div').forEach(d => {
                        if (d.style.borderLeft) {
                            d.style.borderLeft = '3px solid transparent';
                        }
                    });
                    
                    // Add the prompt to the textarea with some formatting
                    entryTextarea.value = `üí≠ Today's Journal Prompt:\n"${prompt}"\n\n`;
                    
                    // Focus on the end of the textarea where they can start writing
                    entryTextarea.focus();
                    entryTextarea.setSelectionRange(entryTextarea.value.length, entryTextarea.value.length);
                    
                    // Set a default title
                    entryTitle.value = `Reflection - ${new Date().toLocaleDateString()}`;
                });
            }
            
            // New Entry functionality
            if (newEntryBtn) {
                newEntryBtn.addEventListener('click', function() {
                    // Save current entry if there's content
                    const title = entryTitle.value.trim();
                    const content = entryTextarea.value.trim();
                    const selectedMood = document.querySelector('.mood-btn[style*="#2d1a45"]');
                    const tagInput = document.getElementById('tag-input');
                    let tags = [];
                    if (tagInput && tagInput.value.trim()) {
                        tags = tagInput.value.split(',').map(t => t.trim()).filter(Boolean);
                    }

                    if (title || content) {
                        // Create new entry object
                        const newEntry = {
                            title: title || 'Untitled Entry',
                            content: content,
                            mood: selectedMood ? selectedMood.getAttribute('data-mood') : '',
                            tags: tags,
                            date: new Date().toLocaleDateString(),
                            timestamp: Date.now()
                        };
                        
                        // Add to beginning of array
                        journalEntries.unshift(newEntry);
                        
                        // Save to localStorage
                        saveEntriesToStorage();
                        
                        // Refresh the display
                        displaySavedEntries();
                    }
                    
                    // Clear form for new entry
                    entryTitle.value = '';
                    entryTextarea.value = '';
                    if (tagInput) tagInput.value = '';
                    
                    // Reset mood selection
                    document.querySelectorAll('.mood-btn').forEach(b => {
                        b.style.borderColor = '#ddd';
                        b.style.background = 'white';
                    });
                    
                    // Reset entry selection
                    document.querySelectorAll('#entries-list > div').forEach(d => {
                        if (d.style.borderLeft) {
                            d.style.borderLeft = '3px solid transparent';
                        }
                    });
                    
                    // Focus on title input
                    entryTitle.focus();
                });
            }
            
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        });
        
        // --- Voice Journal functionality (audio recording) ---
        document.addEventListener('DOMContentLoaded', function() {
            // ...existing code...
            const startVoiceBtn = document.getElementById('start-voice');
            const stopVoiceBtn = document.getElementById('stop-voice');
            const voiceStatus = document.getElementById('voice-status');
            const voicePlayback = document.getElementById('voice-playback');
            let mediaRecorder, audioChunks = [], audioBlobUrl = null;
            let isRecording = false;

            // Audio recording using MediaRecorder API
            if (navigator.mediaDevices && window.MediaRecorder) {
                startVoiceBtn.addEventListener('click', async function() {
                    if (isRecording) return;
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        mediaRecorder.ondataavailable = function(e) {
                            if (e.data.size > 0) audioChunks.push(e.data);
                        };
                        mediaRecorder.onstop = function() {
                            if (audioChunks.length) {
                                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                                if (audioBlobUrl) URL.revokeObjectURL(audioBlobUrl);
                                audioBlobUrl = URL.createObjectURL(audioBlob);
                                voicePlayback.src = audioBlobUrl;
                                voicePlayback.style.display = '';
                                voiceStatus.textContent = 'Voice journal recorded. You can play it back below.';
                            }
                        };
                        mediaRecorder.start();
                        isRecording = true;
                        startVoiceBtn.style.display = 'none';
                        stopVoiceBtn.style.display = '';
                        voiceStatus.textContent = 'Recording... Speak your journal entry.';
                        voicePlayback.style.display = 'none';
                        voicePlayback.src = '';
                    } catch (err) {
                        voiceStatus.textContent = 'Microphone access denied or unavailable.';
                    }
                });

                stopVoiceBtn.addEventListener('click', function() {
                    if (!isRecording || !mediaRecorder) return;
                    mediaRecorder.stop();
                    isRecording = false;
                    startVoiceBtn.style.display = '';
                    stopVoiceBtn.style.display = 'none';
                });
            } else {
                startVoiceBtn.disabled = true;
                startVoiceBtn.textContent = 'Voice Journal Not Supported';
                voiceStatus.textContent = 'Your browser does not support audio recording.';
            }

            // ...existing code...
        });

        // Debug scrolling issue
        document.addEventListener('DOMContentLoaded', function() {
            // Check if there are any CSS rules preventing scrolling
            console.log('Body height:', document.body.scrollHeight);
            console.log('Window height:', window.innerHeight);
            console.log('Document height:', document.documentElement.scrollHeight);
            
            // Force enable scrolling
            document.body.style.overflow = 'visible';
            document.documentElement.style.overflow = 'visible';
            document.body.style.height = 'auto';
            document.documentElement.style.height = 'auto';
        });

        document.addEventListener('DOMContentLoaded', function() {
            // ...existing code...

            // Fix: Ensure Delete button clears all fields and audio
            const clearBtn = document.getElementById('clear-entry');
            const entryTitle = document.querySelector('input[placeholder="Entry Title"]');
            const entryTextarea = document.querySelector('textarea');
            const tagInput = document.getElementById('tag-input');
            const voicePlayback = document.getElementById('voice-playback');
            const voiceStatus = document.getElementById('voice-status');
            const startVoiceBtn = document.getElementById('start-voice');
            const stopVoiceBtn = document.getElementById('stop-voice');
            let isRecording = false;
            let mediaRecorder = null;
            let stream = null;

            // If you have a global isRecording/mediaRecorder/stream, remove these lines above and use the global ones.

            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    // Clear text fields
                    if (entryTitle) entryTitle.value = '';
                    if (entryTextarea) entryTextarea.value = '';
                    if (tagInput) tagInput.value = '';
                    // Reset mood selection
                    document.querySelectorAll('.mood-btn').forEach(b => {
                        b.style.borderColor = '#ddd';
                        b.style.background = 'white';
                    });
                    // Remove audio playback and revoke blob URL if any
                    if (voicePlayback) {
                        if (voicePlayback.src && voicePlayback.src.startsWith('blob:')) {
                            try { URL.revokeObjectURL(voicePlayback.src); } catch {}
                        }
                        voicePlayback.removeAttribute('src');
                        voicePlayback.load();
                        voicePlayback.style.display = 'none';
                    }
                    if (voiceStatus) voiceStatus.textContent = '';
                    // Stop recording if in progress
                    if (typeof isRecording !== "undefined" && isRecording && mediaRecorder) {
                        try { mediaRecorder.stop(); } catch {}
                        isRecording = false;
                        if (startVoiceBtn) startVoiceBtn.style.display = '';
                        if (stopVoiceBtn) stopVoiceBtn.style.display = 'none';
                    }
                    if (typeof stream !== "undefined" && stream) {
                        try { stream.getTracks().forEach(track => track.stop()); } catch {}
                        stream = null;
                    }
                });
            }

            // ...existing code...
        });

        // Prompt categories and prompts
        const promptCategories = {
            growth: [
                "What's something you've learned about yourself in the past month?",
                "Describe a moment when you felt truly proud of who you are.",
                "What's one habit you want to develop, and why is it important to you?",
                "What's one way you've grown or changed in the past six months?",
                "Describe a mistake you made that taught you something valuable."
            ],
            motivation: [
                "What does success mean to you personally, beyond what others expect?",
                "What's a dream you've been putting off? What's one small step you could take toward it today?",
                "Write about a person who inspires you. What qualities do they have that you admire?",
                "What's something you're excited about in the near future?",
                "If you could master any skill instantly, what would it be and how would you use it?"
            ],
            stress: [
                "Describe a challenge you're facing. What strengths do you have to overcome it?",
                "What's something you've been avoiding, and what's the first step to facing it?",
                "Describe a time when you surprised yourself with your own strength or resilience.",
                "If you could give advice to someone going through what you went through last year, what would you say?",
                "What's one fear you've overcome recently, and how did it change you?"
            ],
            dreams: [
                "Describe your biggest dream. What would achieving it feel like?",
                "Describe your ideal day from morning to night. What would make it perfect?",
                "If you could have a conversation with your future self, what would you want to know?",
                "Write about a tradition or ritual that's meaningful to you and why.",
                "What would you do if you knew you couldn't fail?"
            ]
        };

        document.addEventListener('DOMContentLoaded', function() {
            // ...existing code...

            // Modal logic for Get Prompt
            const getPromptBtn = Array.from(document.querySelectorAll('button')).find(btn => btn.textContent.trim() === 'Get Prompt');
            const promptModal = document.getElementById('prompt-modal');
            const closePromptModal = document.getElementById('close-prompt-modal');
            const promptCategoriesDiv = document.getElementById('prompt-categories');
            // Remove promptListDiv, promptItemsDiv, backToCategoriesBtn (not needed)
            const entryTitle = document.querySelector('input[placeholder="Entry Title"]');
            const entryTextarea = document.querySelector('textarea');

            if (getPromptBtn && promptModal) {
                getPromptBtn.addEventListener('click', function() {
                    promptModal.style.display = 'flex';
                    promptCategoriesDiv.style.display = 'flex';
                });
            }
            if (closePromptModal) {
                closePromptModal.addEventListener('click', function() {
                    promptModal.style.display = 'none';
                });
            }
            if (promptModal) {
                promptModal.addEventListener('click', function(e) {
                    if (e.target === promptModal) promptModal.style.display = 'none';
                });
            }
            // Category button click: show prompt after a short delay for feedback
            document.querySelectorAll('.prompt-cat-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const cat = btn.getAttribute('data-cat');
                    const prompts = promptCategories[cat] || [];
                    if (prompts.length > 0) {
                        promptCategoriesDiv.style.display = 'none';
                        setTimeout(() => {
                            const prompt = prompts[Math.floor(Math.random() * prompts.length)];
                            if (entryTextarea) {
                                entryTextarea.value = `üí≠ Today's Journal Prompt:\n"${prompt}"\n\n`;
                                entryTextarea.focus();
                                entryTextarea.setSelectionRange(entryTextarea.value.length, entryTextarea.value.length);
                            }
                            if (entryTitle) {
                                entryTitle.value = `Reflection - ${new Date().toLocaleDateString()}`;
                            }
                            promptModal.style.display = 'none';
                        }, 250); // 250ms delay for smoothness
                    }
                });
            });
            // Remove/ignore the prompt-list and prompt-items logic since we don't show a list anymore
            // ...existing code...
        });

        // --- Debugging and testing code ---
        document.addEventListener('DOMContentLoaded', function() {
            // Debugging: Log journalEntries on load
            console.log('Loaded journalEntries:', JSON.parse(localStorage.getItem('journalEntries')));

            // Test: Force open the prompt modal on load (for debugging)
            // Uncomment the line below to test
            // document.getElementById('prompt-modal').style.display = 'flex';

            // Test: Pre-fill an entry (for debugging)
            const testEntry = {
                title: "Test Entry",
                content: "This is a test journal entry.",
                mood: "üòä",
                tags: ["test", "journal"],
                date: new Date().toLocaleDateString(),
                timestamp: Date.now()
            };
            journalEntries.push(testEntry);
            saveEntriesToStorage();
            displaySavedEntries();
        });
    </script>
</body>
</html>